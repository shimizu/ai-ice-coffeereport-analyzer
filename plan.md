# 機能追加計画: 前回分析データとの比較分析 (Trend Context Analysis)

## 概要
AI分析時に、Firestoreに保存されている「最新（前回）の分析結果」を取得し、Geminiのプロンプトにコンテキストとして渡す機能を実装する。
これにより、AIは単一のレポートだけでなく、前回からの**「変化（トレンド）」**や**「異常な乖離」**を認識した上で、より文脈に即したインサイト（強気/弱気スコアの変化理由など）を提供できるようになる。

## 目標
1.  分析実行時に自動的に前回のレポートデータをDBから取得する。
2.  Geminiへのプロンプトに「前回データ」を含め、比較分析を行わせる。
3.  出力結果に「前回比（Change from Previous）」の精度向上や、トレンドに関する言及を含める。

## タスクリスト

### Phase 1: データ取得ロジックの実装
- [ ] **`services/dbService.ts` への機能追加**:
    - `getLatestDocument()` 関数を実装。
    - Firestoreの `documents` コレクションから、`report_date` (または `timestamp`) の降順で1件だけデータを取得するクエリを作成。
    - エラーハンドリング（初回実行時など、データが存在しない場合の考慮）。

### Phase 2: AI分析サービスの拡張
- [ ] **`services/geminiService.ts` の改修**:
    - `analyzeDocument` 関数内で `getLatestDocument()` を呼び出す。
    - プロンプトの構築ロジックを変更し、前回データが存在する場合は `=== PREVIOUS REPORT CONTEXT ===` セクションを追加。
    - 比較すべき重要項目（総在庫、Transition比率、スコア、主要倉庫在庫）をAIに提示。
    - プロンプトの指示（Instructions）に、「前回データとの比較に基づき、変化の方向性を評価すること」を追加。

### Phase 3: 動作確認
- [ ] **テスト実行**:
    - 1回目：新規データのアップロード（比較対象なし）。
    - 2回目：日付の新しいデータのアップロード（前回データとの比較が反映されているか確認）。
    - ログや出力結果で、前回データがプロンプトに含まれているか確認。

## 期待される効果
- 「前回よりTransition比率が急増しており、需給逼迫感は見た目より緩和している」といった、動的な分析が可能になる。
- AIのスコアリング（Bullish/Bearish）が、単発の数値だけでなくトレンドを加味したものになる。
